<!DOCTYPE html>
<html>

<head>
    <title>在线漫画阅读器</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
</head>

<body>

    <div class="control" style="width:100%;">
        <button onclick="previous()" style="height:20px;"><-</button>
        <button onclick="next()" style="height:20px;float:right;">-></button>
        <input id="originalChk" type="CheckBox" name="original" value="original" onChange="onOriginalChanged()" />原图
    </div>
    
    <img id="image" alt="image" src="" />
    
    <div class="control" style="width:100%;">
        <button onclick="previous()" style="height:20px;"><-</button>
        <button onclick="next()" style="height:20px;float:right;">-></button>
    </div>

    <script type="text/javascript">
    var data;
    var index = 0;
    getData();
    
    function getData(){
        var url = getURL();
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url);
        xhr.onreadystatechange = function(){
            if(xhr.readyState === 4){
                console.log(xhr.status);
                console.log(xhr.responseText);
                data = JSON.parse(xhr.responseText);
                loadImage(getPageIndex());
                console.log(data);
            }
        }
        xhr.send();
    }
    
    function getPageIndex(){
        var page = getQueryVariable("page");
        if (page == "") {
            return 0;
        }else{
            return parseInt(page - 1);
        }
    }
    
    function getURL(){
        var url;
        var uniqueName = getQueryVariable("uniquename");
        if (uniqueName == "") {
            url = "./data.json";
            root = "./";
        }else{
            url = "./data/"+ uniqueName + "/data.json";
            root = "./data/"+ uniqueName;
        }
        
        return url;
    }
    
    function getQueryVariable(variable){
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i=0;i<vars.length;i++) {
            var pair = vars[i].split("=");
            if(pair[0] == variable){return pair[1];}
        }
        return "";
    }
    
    function loadImage(offset){
        var images = data["images"];
        index = index + offset;
        index = handleBounds(index);
        var imgUrl;
        
        var original = getOriginal();
        if (original == "yes"){
            imgUrl = root + "/" + images[index];
        } else{
            imgUrl = root + "/out/" + images[index];
        }

        document.getElementById("image").src=imgUrl;
    }
    
    function handleBounds(index) {
        var images = data["images"];
        index = Math.min(images.length - 1, index);
        index = Math.max(0, index);
        return index;
    }
    
    function previous(){
        if (index<=0){
            alert("到底了");
            return;
        }
        
        window.location.href = window.location.origin +window.location.pathname + "?page=" + Math.max(1, index) + "&original="+getOriginal();
    }
    
    function next(){
        var maxPage = data["images"].length;
        var newPage = index + 1 + 1;
        
        if (newPage>maxPage){
            alert("到底了");
            return;
        }
        
        window.location.href = window.location.origin +window.location.pathname + "?page=" + newPage + "&original="+getOriginal();
    }
    
    function onOriginalChanged(){
        console.log("changed.");
        var original = "no";
        if (document.getElementById("originalChk").checked == true){
            original = "yes";
        }
        window.location.href = window.location.origin +window.location.pathname + "?page=" + (index+1) + "&original="+original;
    }
    
    function getOriginal(){
        var original = getQueryVariable("original");
        if (original == "yes"){
            document.getElementById("originalChk").checked = true;
        } else{
            original = "no";
            document.getElementById("originalChk").checked = false;
        }
        return original;
    }
    </script>
</body>

</html>